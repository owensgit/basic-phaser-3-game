<!DOCTYPE html>
<html>
  <head>
    <script src="node_modules/phaser/dist/phaser-arcade-physics.min.js"></script>
  </head>
  <body>
    <script type="text/javascript">
      let platforms;
      let player;
      let cursors;
      let currentlyFacing = 'right';
      let coins;
      let coins2;
      var score = 0;
      var scoreText;
      var timerText;
      var timeLeft = 45;
      var timerInterval;
      var baddies;
      var gameIsOver = false;

      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
          default: 'arcade',
          arcade: {
            gravity: { y: 300 },
            debug: false,
          },
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };

      var game = new Phaser.Game(config);

      function preload() {
        this.load.image('sky', 'assets/sky.jpg');
        this.load.image('coin', 'assets/coin.png');
        this.load.image('bear', 'assets/bear.png');
        this.load.image('platform-2-tiles', 'assets/platforms/platform-2-tiles.png');
        this.load.image('platform-3-tiles', 'assets/platforms/platform-3-tiles.png');
        this.load.image('platform-4-tiles', 'assets/platforms/platform-4-tiles.png');
        this.load.image('platform-5-tiles', 'assets/platforms/platform-5-tiles.png');
        this.load.image('platform-6-tiles', 'assets/platforms/platform-6-tiles.png');
        this.load.image('platform-7-tiles', 'assets/platforms/platform-7-tiles.png');
        this.load.image('platform-8-tiles', 'assets/platforms/platform-8-tiles.png');
        this.load.image('platform-9-tiles', 'assets/platforms/platform-9-tiles.png');
        this.load.image('platform-10-tiles', 'assets/platforms/platform-10-tiles.png');
        this.load.image('platform-25-tiles', 'assets/platforms/platform-25-tiles.png');

        this.load.spritesheet('dude', 'assets/dude/dude-sprite.png', {
          frameWidth: 32,
          frameHeight: 32,
        });
      }

      function create() {
        this.add.image(0, 0, 'sky').setOrigin(0, 0);
        platforms = this.physics.add.staticGroup();
        coins = this.physics.add.group();
        baddies = this.physics.add.staticGroup();

        addGround();
        addFirstPlatforms();
        addSecondPlatforms();
        addThirdPlatforms();
        addFourthPlatforms();

        createPlayer.bind(this)();

        cursors = this.input.keyboard.createCursorKeys();

        scoreText = this.add.text(620, 16, 'Coins: 0', { fontSize: '30px', fill: '#FFF' });
        timerText = this.add.text(20, 16, `Time: ${timeLeft}`, { fontSize: '30px', fill: '#FFF' });

        this.physics.add.collider(player, platforms);
        this.physics.add.collider(coins, platforms);
        this.physics.add.collider(baddies, platforms);
        this.physics.add.overlap(player, coins, collectCoin, null, this);
        this.physics.add.collider(player, baddies, gameOver.bind(this), null, this);

        setTimeout(gameOver.bind(this), (timeLeft + 1) * 1000);
        timerInterval = setInterval(updateTime, 1000);
      }

      function update() {
        if (gameIsOver) {
          return;
        }

        if (cursors.left.isDown) {
          player.setVelocityX(-145);
          player.anims.play('left', true);
          currentlyFacing = 'left';
        } else if (cursors.right.isDown) {
          player.setVelocityX(145);
          player.anims.play('right', true);
          currentlyFacing = 'right';
        } else {
          player.setVelocityX(0);
          if (currentlyFacing === 'left') {
            player.anims.play('idle-left');
          } else {
            player.anims.play('idle-right');
          }
        }

        if (cursors.up.isDown && player.body.touching.down) {
            player.setVelocityY(-205);
        }
      }

      //#region BUILD THE LEVEL
      function addGround() {
        platforms.create(400, 584, 'platform-25-tiles');
        baddies.create(400, 584 - 32, 'bear');
        coins.create(190, 584 - 32, 'coin');
        coins.create(230, 584 - 32, 'coin');
        coins.create(540, 584 - 32, 'coin');
        coins.create(500, 584 - 32, 'coin');
        coins.create(600, 584 - 32, 'coin');
      }

      function addFirstPlatforms() {
        // Platform 1
        platforms.create(700, 520, 'platform-3-tiles');
        baddies.create(700, 520  - 32, 'bear');
        coins.create(670, 520 - 32, 'coin');
        coins.create(730, 520 - 32, 'coin');
        
        // Platform 2
        platforms.create(520, 470, 'platform-4-tiles');
        coins.create(520, 470 - 32, 'coin');
        
        // Platform 3
        platforms.create(370, 450, 'platform-3-tiles');
        coins.create(370, 450 - 32, 'coin');

        // Platform 4
        platforms.create(230, 479, 'platform-3-tiles');
        baddies.create(230, 479 - 32, 'bear');
        coins.create(200, 479 - 32, 'coin');
      }

      function addSecondPlatforms() {
        // Platform 1
        platforms.create(55, 410, 'platform-3-tiles');
        coins.create(35, 410 - 32, 'coin');
        coins.create(75, 410 - 32, 'coin');

        // Platform 2
        platforms.create(280, 360, 'platform-5-tiles');
        baddies.create(235, 360 - 32, 'bear');
        coins.create(270, 360 - 32, 'coin');
        coins.create(305, 360 - 32, 'coin');
        coins.create(340, 360 - 32, 'coin');

        // Platform 3
        platforms.create(500, 370, 'platform-3-tiles');
        baddies.create(497, 370 - 32, 'bear');
        coins.create(465, 370 - 32, 'coin');
        coins.create(540, 370 - 32, 'coin');

        // Platform 4
        platforms.create(620, 350, 'platform-2-tiles');
        coins.create(620, 350 - 32, 'coin');
      }
      
      function addThirdPlatforms() {
        // Platform 1
        platforms.create(740, 300, 'platform-2-tiles');
        coins.create(740, 300 - 32, 'coin');
        
        // Platform 2
        platforms.create(570, 240, 'platform-3-tiles');
        baddies.create(570, 240 - 32, 'bear');
        coins.create(530, 240 - 32, 'coin');
        coins.create(600, 240 - 32, 'coin');
        
        // Platform 3
        platforms.create(360, 250, 'platform-4-tiles');
        baddies.create(360, 250 - 32, 'bear');
        coins.create(310, 250 - 32, 'coin');
        coins.create(390, 250 - 32, 'coin');
      }
      
      function addFourthPlatforms() {
        // Platform 1
        platforms.create(160, 190, 'platform-4-tiles');
        baddies.create(160, 190 - 32, 'bear');
        coins.create(125, 190 - 32, 'coin');
        
        // Platform 2
        platforms.create(320, 120, 'platform-3-tiles');
        baddies.create(320, 120 - 32, 'bear');
        coins.create(290, 120 - 32, 'coin');
        coins.create(350, 120 - 32, 'coin');
        
        // Platform 3
        platforms.create(500, 80, 'platform-4-tiles');
        coins.create(460, 80 - 32, 'coin');
        coins.create(500, 80 - 32, 'coin');
        coins.create(540, 80 - 32, 'coin');
      }
      // #endregion

      function createPlayer() {
        player = this.physics.add.sprite(100, 500, 'dude').refreshBody();
        player.setBounce(0.2);
        player.setCollideWorldBounds(true);

        this.anims.create({
          key: 'left',
          frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 5 }),
          frameRate: 10,
          repeat: -1,
        });

        this.anims.create({
          key: 'idle-left',
          frames: [{ key: 'dude', frame: 6 }],
          frameRate: 20,
        });

        this.anims.create({
          key: 'idle-right',
          frames: [{ key: 'dude', frame: 7 }],
          frameRate: 20,
        });

        this.anims.create({
          key: 'right',
          frames: this.anims.generateFrameNumbers('dude', { start: 8, end: 13 }),
          frameRate: 10,
          repeat: -1,
        });
      }

      function collectCoin(player, star) {
        star.disableBody(true, true);
        score += 1;
        scoreText.setText('Score: ' + score);
      }

      function gameOver() {
        this.physics.pause();
        playerDie();
        gameIsOver = true;
        clearInterval(timerInterval);
      }

      function playerIdle() {
        if (currentlyFacing === 'left') {
          player.anims.play('idle-left');
        } else {
          player.anims.play('idle-right');
        }
      }

      function playerDie() {
        player.setTint(0xff0000);
        setTimeout(playerIdle, 0);
      }

      function updateTime() {
        timeLeft--;
        timerText.setText('Time: ' + timeLeft);
      }
    </script>
  </body>
</html>
